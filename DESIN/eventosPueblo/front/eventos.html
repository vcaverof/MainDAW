<script src="https://cdn.tailwindcss.com"></script>
<script src="./js/main.js"></script>

<div class="bg-gray-50 text-gray-800">

    <!-- NAVBAR -->
    <div id="navbar"></div>

    <div class="max-w-5xl mx-auto mt-10 px-6">

        <!-- FILTRO DE MUNICIPIOS -->
        <div class="mb-8 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <h2 class="text-xl font-semibold mb-4">Filtrar eventos</h2>

            <div class="flex flex-col md:flex-row gap-4 items-center">
                <label for="municipio" class="font-medium">Municipio:</label>

                <select id="municipio"
                    class="border border-gray-300 rounded-md px-3 py-2 bg-white focus:ring-2 focus:ring-green-300 focus:outline-none">
                </select>

                <button onclick="filtrar()" class="px-4 py-2 bg-green-200 hover:bg-green-300 rounded-md transition">
                    Filtrar
                </button>

                <button onclick="quitarFiltro()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md transition">
                    Quitar filtro
                </button>

                <button onclick="eventosDisponibles()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-md transition">
                    Disponibles
                </button>
            </div>
        </div>

        <!-- LISTA DE EVENTOS -->
        <div id="lista" class="space-y-6"></div>

    </div>

    <!-- CARGA DEL NAVBAR -->
    <script>
        cargarNavbar();
    </script>

    <script src="js/api.js"></script>

    <script>
        async function cargarEventos() {
            const eventos = await apiGet("/eventos");
            mostrarEventos(eventos);
        }

        async function apuntarse(id) {
            await apiPost(`/eventos/${id}/apuntarse`);
            alert("Te has apuntado");
        }

        async function cargarMunicipios() {
            const municipios = await apiGet("/municipios");

            const select = document.getElementById("municipio");
            select.innerHTML = "";

            municipios.forEach(m => {
                select.innerHTML += `<option value="${m.id}">${m.nombre}</option>`;
            });
        }

        async function filtrar() {
            const id = document.getElementById("municipio").value;
            const eventos = await apiGet(`/eventos/municipio/${id}`);
            mostrarEventos(eventos);
        }

        async function quitarFiltro() {
            const eventos = await apiGet("/eventos");
            mostrarEventos(eventos);
        }

        function mostrarEventos(eventos) {
            const contenedor = document.getElementById("lista");
            contenedor.innerHTML = "";

            if (eventos.length === 0) {
                contenedor.innerHTML = `
                    <p class="text-gray-500 text-center">No hay eventos para este municipio.</p>
                `;
                return;
            }

            eventos.forEach(e => {
                contenedor.innerHTML += `
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-lg font-semibold mb-2">${e.nombre}</h3>
                    <p class="text-gray-700 mb-2">${e.descripcion}</p>
                    <p class="text-gray-600"><strong>Fecha:</strong> ${e.fecha}</p>
                    <p class="text-gray-600 mb-4"><strong>Municipio:</strong> ${e.municipio.nombre}</p>

                    <button onclick="apuntarse(${e.id})"
                        class="px-4 py-2 bg-green-200 hover:bg-green-300 rounded-md transition">
                        Apuntarse
                    </button>
                </div>
                `;
            });
        }

        async function eventosDisponibles() {
            await apiGet('/eventos-disponibles');
            window.location.href = 'eventos-disponibles.html';
        }

        async function logout() {
            await apiPost("/logout");
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }

        function mostrarBotonAdmin() {
            const user = JSON.parse(localStorage.getItem("user"));
            const adminBtn = document.getElementById("adminBtn");

            if (!adminBtn) return;

            if (!user || user.rol_id !== 1) {
                adminBtn.classList.add("hidden");
            }
        }

        mostrarBotonAdmin();

        async function iniciar() {
            await cargarMunicipios();
            await cargarEventos();
        }

        iniciar();
    </script>
</div>