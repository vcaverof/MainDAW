<h1>Editar evento</h1>

<button onclick="volverAdmin()">Volver al panel admin</button>
<button onclick="logout()">Cerrar sesión</button>

<hr>

<form onsubmit="guardarCambios(event)">
    <label>Nombre:</label><br>
    <input type="text" id="nombre" required><br><br>

    <label>Descripción:</label><br>
    <textarea id="descripcion" required></textarea><br><br>

    <label>Fecha:</label><br>
    <input type="date" id="fecha" required><br><br>

    <label>Municipio:</label><br>
    <select id="municipio"></select><br><br>

    <button type="submit">Guardar cambios</button>
</form>

<script src="js/api.js"></script>
<script>
    let eventoId = null;

    function requireAdmin() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || user.rol_id !== 1) {
            alert("No tienes permisos para acceder aquí");
            window.location.href = "eventos.html";
        }
    }

    function obtenerIdEvento() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
    }

    async function cargarMunicipios() {
        const municipios = await apiGet("/municipios");
        const select = document.getElementById("municipio");

        municipios.forEach(m => {
            select.innerHTML += `<option value="${m.id}">${m.nombre}</option>`;
        });
    }

    async function cargarEvento() {
        const evento = await apiGet(`/eventos/${eventoId}`);

        document.getElementById("nombre").value = evento.nombre;
        document.getElementById("descripcion").value = evento.descripcion;
        document.getElementById("fecha").value = evento.fecha;
        document.getElementById("municipio").value = evento.municipio_id;
    }

    async function guardarCambios(ev) {
        ev.preventDefault();

        const data = {
            nombre: document.getElementById("nombre").value,
            descripcion: document.getElementById("descripcion").value,
            fecha: document.getElementById("fecha").value,
            municipio_id: document.getElementById("municipio").value
        };

        await apiPut(`/eventos/${eventoId}`, data);

        alert("Cambios guardados correctamente");
        window.location.href = "admin.html";
    }

    function volverAdmin() {
        window.location.href = "admin.html";
    }

    async function logout() {
        await apiPost("/logout");
        localStorage.clear();
        window.location.href = "login.html";
    }

    async function iniciar() {
        requireAdmin();
        eventoId = obtenerIdEvento();
        await cargarMunicipios();
        await cargarEvento();
    }

    iniciar();
</script>